
{% comment %} index.html {% endcomment %}

{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printgrid</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 15px;
        }
        
        .card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }
        
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .card-body {
            padding: 25px;
        }
        
        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 2000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .loading-indicator.active {
            visibility: visible;
            opacity: 1;
        }
        
        .tooltip-helper {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(33, 37, 41, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1050;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .tooltip-helper.show {
            opacity: 1;
        }
        
        .sticker-preview {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            padding: 10px;
            display: inline-block;
        }
        
        .paper-visual {
            width: 120px;
            height: 170px;
            margin: 0 auto;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        
        .printable-area {
            position: absolute;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            border: 1px dashed #0d6efd;
            background-color: rgba(13, 110, 253, 0.05);
        }
        
        .step-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-color: #e9ecef;
            border-radius: 50%;
            margin-right: 15px;
            color: #495057;
            font-weight: bold;
        }
        
        .layout-preview {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .realtime-preview {
            display: none;
            margin-top: 1rem;
        }
        
        .sticker-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #0d6efd;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .recent-layout-item {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .recent-layout-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <header class="bg-white shadow-sm">
        <div class="container py-3">
            <div class="d-flex align-items-center justify-content-between">
                <h1 class="h4 mb-0">
                    <i class="fas fa-tag me-2 text-primary"></i> 
                    PrintGrid
                </h1>
                <a href="#" class="btn btn-outline-primary d-none d-md-inline-block" id="help-btn">
                    <i class="fas fa-question-circle me-1"></i> Help
                </a>
            </div>
        </div>
    </header>
    
    <div class="main-container">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Create Sticker Layout</span>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{% url 'calculate_layout' %}" enctype="multipart/form-data" id="layout-form">
                            {% csrf_token %}
                       
                            <!-- Step 1: Upload Image -->
                            <div class="mb-4">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="step-icon">1</div>
                                    <h5 class="mb-0">Upload Your Sticker or Flyer</h5>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="sticker_image" class="form-label">
                                        Image <span class="text-danger"></span>
                                    </label>
                                    <input type="file" class="form-control" id="sticker_image" name="sticker_image" accept="image/*" required>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i> 
                                        Supported formats: PNG, JPG, GIF, SVG
                                    </div>
                                </div>
                                
                                <div id="sticker_preview" class="text-center mb-3 d-none">
                                    <p><small class="text-muted">Preview:</small></p>
                                    <div class="sticker-preview">
                                        <img id="preview_image" class="img-fluid rounded" style="max-height: 150px;">
                                    </div>
                                </div>
                                
                                <!-- Auto-detected dimensions -->
                                <div id="auto_dimensions" class="d-none">
                                    <div class="alert alert-info mb-3">
                                        <div class="mb-2">
                                            <i class="fas fa-ruler-combined me-2"></i>
                                            <strong>Detected cc Dimensions:</strong>
                                        </div>
                                        <div class="row">
                                            <div class="col-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="dimension_unit" id="unit_mm" value="mm" checked>
                                                    <label class="form-check-label" for="unit_mm">
                                                        <span id="dim_mm">0 × 0</span> mm
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="dimension_unit" id="unit_inches" value="inches">
                                                    <label class="form-check-label" for="unit_inches">
                                                        <span id="dim_inches">0 × 0</span> inches
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="dimension_unit" id="unit_pixels" value="pixels">
                                                    <label class="form-check-label" for="unit_pixels">
                                                        <span id="dim_pixels">0 × 0</span> pixels
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-2 small text-muted">
                                            Detected at <span id="dim_dpi">72 × 72</span> DPI. 
                                            <button type="button" class="btn btn-link btn-sm p-0" id="use_detected_size">
                                                <i class="fas fa-magic me-1"></i> Use these dimensions
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col">
                                        <div class="mb-3">
                                            <label for="sticker_width" class="form-label">
                                                Width (mm) <span class="text-danger"></span>
                                            </label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="sticker_width" name="sticker_width" min="5" max="1000" required step="0.1">
                                                <span class="input-group-text">mm</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="mb-3">
                                            <label for="sticker_height" class="form-label">
                                                Height (mm) <span class="text-danger"></span>
                                            </label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="sticker_height" name="sticker_height" min="5" max="1000" required step="0.1">
                                                <span class="input-group-text">mm</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 2: Paper Settings -->
                            <div class="mb-4">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="step-icon">2</div>
                                    <h5 class="mb-0">Canvas Settings</h5>
                                </div>
                                
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                       
                                        
                                        <div id="standard_paper_options">
                                            <div class="mb-3">
                                                <label for="paper_size" class="form-label">
                                                    Canvas Size <span class="text-danger"></span>
                                                </label>
                                                <select class="form-select" id="paper_size" name="paper_size" required>
                                                    {% for size in paper_sizes %}
                                                        <option value="{{ size.id }}" data-width="{{ size.width_mm }}" data-height="{{ size.height_mm }}">
                                                            {{ size.name }} ({{ size.width_mm }}mm × {{ size.height_mm }}mm)
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div id="custom_paper_options" class="d-none">
                                            <div class="row">
                                                <div class="col-6">
                                                    <div class="mb-3">
                                                        <label for="custom_paper_width" class="form-label">
                                                            Width (mm)
                                                        </label>
                                                        <div class="input-group">
                                                            <input type="number" class="form-control" id="custom_paper_width" name="custom_paper_width" value="210" min="50" max="2000" step="0.1">
                                                            <span class="input-group-text">mm</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="mb-3">
                                                        <label for="custom_paper_height" class="form-label">
                                                            Height (mm)
                                                        </label>
                                                        <div class="input-group">
                                                            <input type="number" class="form-control" id="custom_paper_height" name="custom_paper_height" value="297" min="50" max="2000" step="0.1">
                                                            <span class="input-group-text">mm</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="paper_orientation" class="form-label">
                                                Orientation
                                            </label>
                                            <select class="form-select" id="paper_orientation" name="paper_orientation">
                                                <option value="portrait">Portrait</option>
                                                <option value="landscape">Landscape</option>
                                            </select>
                                        </div>

 <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="use_custom_paper" name="use_custom_paper" value="true">
                                            <label class="form-check-label" for="use_custom_paper">
                                                Use custom paper size
                                            </label>
                                        </div>

                                    </div>
                                    <div class="col-md-6">
                                        <div id="paper-preview" class="text-center mb-3">
                                            <div class="paper-visual">
                                                <div class="printable-area"></div>
                                            </div>
                                            <div class="small text-muted mt-2">
                                                <i class="fas fa-info-circle me-1"></i> Paper visualization with printable area
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 3: Margin & Spacing Settings -->
                            <div class="mb-4">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="step-icon">3</div>
                                    <h5 class="mb-0">Margins & Spacing</h5>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="mb-2">Space Around</h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="mb-3">
                                                    <label for="margin_top" class="form-label">Top</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="margin_top" name="margin_top" value="10" min="0" max="100" step="0.5">
                                                        <span class="input-group-text">mm</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="mb-3">
                                                    <label for="margin_right" class="form-label">Right</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="margin_right" name="margin_right" value="10" min="0" max="100" step="0.5">
                                                        <span class="input-group-text">mm</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="mb-3">
                                                    <label for="margin_bottom" class="form-label">Bottom</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="margin_bottom" name="margin_bottom" value="10" min="0" max="100" step="0.5">
                                                        <span class="input-group-text">mm</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="mb-3">
                                                    <label for="margin_left" class="form-label">Left</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="margin_left" name="margin_left" value="10" min="0" max="100" step="0.5">
                                                        <span class="input-group-text">mm</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="mb-2">Spacing Between Stickers</h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="mb-3">
                                                    <label for="horizontal_spacing" class="form-label">Horizontal</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="horizontal_spacing" name="horizontal_spacing" value="2" min="0" max="50" step="0.5">
                                                        <span class="input-group-text">mm</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="mb-3">
                                                    <label for="vertical_spacing" class="form-label">Vertical</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="vertical_spacing" name="vertical_spacing" value="2" min="0" max="50" step="0.5">
                                                        <span class="input-group-text">mm</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="realtime-preview" id="realtime-preview">
                                            <div class="small text-muted mb-1">Realtime Layout Preview:</div>
                                            <div class="layout-preview">
                                                <div id="preview-canvas" class="position-relative" style="width: 150px; height: 212px; background: white; border: 1px solid #dee2e6;">
                                                    <!-- Sticker dots will be added here -->
                                                </div>
                                            </div>
                                            <div class="small text-muted mt-1">
                                                <span id="sticker-count">0</span> stickers per page
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            


     
                            <!-- Layout name -->
                            <div class="mb-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="layout_name" class="form-label">Layout Name</label>
                                            <input type="text" class="form-control" id="layout_name" name="layout_name" value="New Layout">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" id="calculate-btn">
                                    <i class="fas fa-calculator me-2"></i> Calculate & Generate Layout
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                {% if recent_layouts %}
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-history me-2"></i> Recent Layouts
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            {% for layout in recent_layouts %}
                            <div class="col-md-4">
                                <div class="card recent-layout-item h-100">
                                    <div class="card-body p-3">
                                        <h6 class="card-title text-truncate">{{ layout.name }}</h6>
                                        <p class="card-text small text-muted mb-2">
                                            {{ layout.paper_size.name }}, {{ layout.layout_data.total_stickers }} stickers
                                        </p>
                                        <p class="card-text small text-muted mb-0">
                                            {{ layout.created_at|date:"M d, Y" }}
                                        </p>
                                    </div>
                                    <div class="card-footer bg-transparent p-3 pt-0 border-0">
                                        <a href="{% url 'edit_layout' layout_id=layout.id %}" class="btn btn-sm btn-outline-primary w-100">
                                            <i class="fas fa-edit me-1"></i> Edit
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">
                        <i class="fas fa-question-circle me-2 text-primary"></i>
                        How to Use the Sticker Layout Generator
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6 class="mb-3">About This Tool</h6>
                    <p>
                        The Sticker Layout Generator helps you create printable layouts for your stickers or flyers. 
                        It automatically calculates how many items can fit on a page and arranges them optimally.
                    </p>
                    
                    <hr>
                    
                    <h6 class="mb-3">Step 1: Upload Your Image</h6>
                    <p>
                        <strong>Upload a sticker image:</strong> This should be a single design that you want to arrange on a page.
                    </p>
                    <p>
                        <strong>Specify dimensions:</strong> Enter the physical dimensions of your sticker in millimeters. 
                        The system can also detect dimensions automatically from your image.
                    </p>
                    
                    <hr>
                    
                    <h6 class="mb-3">Step 2: Canvas Settings</h6>
                    <p>
                        <strong>Canvas size:</strong> Select from standard paper sizes or create a custom size.
                    </p>
                    <p>
                        <strong>Orientation:</strong> Choose portrait (taller than wide) or landscape (wider than tall).
                    </p>
                    
                    <hr>
                    
                    <h6 class="mb-3">Step 3: Margins and Spacing</h6>
                    <p>
                        <strong>Margins:</strong> Set the non-printable area around the edges of your paper (in mm).
                    </p>
                    <p>
                        <strong>Spacing:</strong> Define how much space to leave between items on the page (in mm).
                    </p>
                    
                    <hr>
                    
                    <h6 class="mb-3">Step 4: Layout Editor</h6>
                    <p>
                        After calculating the layout, you can:
                    </p>
                    <ul>
                        <li>View the arranged items on the page</li>
                        <li>Adjust positions by dragging items</li>
                        <li>Add, clone, or remove items</li>
                        <li>Use undo/redo to track your changes</li>
                        <li>Download as PDF or PNG for printing</li>
                    </ul>
                    
                    <hr>
                    
                    <h6 class="mb-3">Tips</h6>
                    <ul>
                        <li>For best results, ensure your image has good resolution</li>
                        <li>Check your printer's specifications for minimum margin requirements</li>
                        <li>Use the editor to fine-tune the positioning of items</li>
                        <li>You can save your layout for future use</li>
                        <li>Test with a single page before printing in bulk</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it!</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tooltip Helper -->
    <div class="tooltip-helper" id="tooltip-helper"></div>
    
    <!-- Loading Indicator -->
    <div class="loading-indicator" id="global-loading">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5 id="loading-message">Loading...</h5>
    </div>
    
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle global loading indicator
            window.showLoading = function(message = 'Loading...') {
                const loading = document.getElementById('global-loading');
                const messageEl = document.getElementById('loading-message');
                messageEl.textContent = message;
                loading.classList.add('active');
            };
            
            window.hideLoading = function() {
                const loading = document.getElementById('global-loading');
                loading.classList.remove('active');
            };
            
            // Helper tooltip function
            window.showTooltip = function(message, duration = 2000) {
                const tooltip = document.getElementById('tooltip-helper');
                tooltip.textContent = message;
                tooltip.classList.add('show');
                
                setTimeout(function() {
                    tooltip.classList.remove('show');
                }, duration);
            };
            
            // Preview uploaded image and detect dimensions
            document.getElementById('sticker_image').addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    // Show loading indicator
                    window.showLoading('Analyzing image...');
                    
                    // Show preview image
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('preview_image').src = e.target.result;
                        document.getElementById('sticker_preview').classList.remove('d-none');
                    };
                    reader.readAsDataURL(file);
                    
                    // Detect sticker dimensions via AJAX
                    const formData = new FormData();
                    formData.append('sticker_image', file);
                    
                    // Show loading indicator
                    const autoDiv = document.getElementById('auto_dimensions');
                    autoDiv.classList.remove('d-none');
                    autoDiv.innerHTML = '<div class="alert alert-info text-center p-3"><div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div> Detecting image dimensions...</div>';
                    
                    fetch('/detect-sticker-size/', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Hide loading indicator
                        window.hideLoading();
                        
                        if (data.success) {
                            // Display the auto-detected dimensions
                            document.getElementById('auto_dimensions').classList.remove('d-none');
                            document.getElementById('auto_dimensions').innerHTML = `
                                <div class="alert alert-info mb-3">
                                    <div class="mb-2">
                                        <i class="fas fa-ruler-combined me-2"></i>
                                        <strong>Detected Dimensions:</strong>
                                    </div>
                                    <div class="row">
                                        <div class="col-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="dimension_unit" id="unit_mm" value="mm" checked>
                                                <label class="form-check-label" for="unit_mm">
                                                    <span id="dim_mm">${data.dimensions.mm.width} × ${data.dimensions.mm.height}</span> mm
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="dimension_unit" id="unit_inches" value="inches">
                                                <label class="form-check-label" for="unit_inches">
                                                    <span id="dim_inches">${data.dimensions.inches.width} × ${data.dimensions.inches.height}</span> in
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="dimension_unit" id="unit_pixels" value="pixels">
                                                <label class="form-check-label" for="unit_pixels">
                                                    <span id="dim_pixels">${data.dimensions.pixels.width} × ${data.dimensions.pixels.height}</span> px
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-2 small text-muted">
                                        Detected at <span id="dim_dpi">${data.dimensions.dpi.x} × ${data.dimensions.dpi.y}</span> DPI. 
                                        <button type="button" class="btn btn-link btn-sm p-0" id="use_detected_size">
                                            <i class="fas fa-magic me-1"></i> Use these dimensions
                                        </button>
                                    </div>
                                </div>
                            `;
                            
                            // Store the detected dimensions in variables for later use
                            window.detectedDimensions = data.dimensions;
                            
                            // Add event listener to the "Use these dimensions" button
                            document.getElementById('use_detected_size').addEventListener('click', function() {
                                const selectedUnit = document.querySelector('input[name="dimension_unit"]:checked').value;
                                const widthInput = document.getElementById('sticker_width');
                                const heightInput = document.getElementById('sticker_height');
                                
                                if (selectedUnit === 'mm') {
                                    widthInput.value = data.dimensions.mm.width;
                                    heightInput.value = data.dimensions.mm.height;
                                } else if (selectedUnit === 'inches') {
                                    // Convert inches to mm for the form
                                    widthInput.value = (data.dimensions.inches.width * 25.4).toFixed(2);
                                    heightInput.value = (data.dimensions.inches.height * 25.4).toFixed(2);
                                } else if (selectedUnit === 'pixels') {
                                    // Convert pixels to mm for the form
                                    const dpiX = data.dimensions.dpi.x || 72;
                                    const dpiY = data.dimensions.dpi.y || 72;
                                    widthInput.value = ((data.dimensions.pixels.width / dpiX) * 25.4).toFixed(2);
                                    heightInput.value = ((data.dimensions.pixels.height / dpiY) * 25.4).toFixed(2);
                                }
                                
                                // Show tooltip
                                window.showTooltip('Dimensions applied!');
                                
                                // Update real-time preview
                                updateRealTimePreview();
                            });
                            
                            // Add event listeners to the radio buttons
                            document.querySelectorAll('input[name="dimension_unit"]').forEach(function(radio) {
                                radio.addEventListener('change', function() {
                                    document.getElementById('use_detected_size').click();
                                });
                            });
                            
                            // Automatically set the dimensions based on mm if none are set
                            const widthInput = document.getElementById('sticker_width');
                            const heightInput = document.getElementById('sticker_height');
                            
                            if (!widthInput.value && !heightInput.value) {
                                // Use the MM dimensions by default
                                widthInput.value = data.dimensions.mm.width;
                                heightInput.value = data.dimensions.mm.height;
                                
                                // Show tooltip
                                window.showTooltip('Dimensions automatically applied!');
                                
                                // Update real-time preview
                                updateRealTimePreview();
                            }
                        } else {
                            // Show error message
                            document.getElementById('auto_dimensions').innerHTML = `
                                <div class="alert alert-warning mb-3">
                                    <div class="mb-0">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Couldn't detect dimensions:</strong> Please enter them manually.
                                    </div>
                                </div>
                            `;
                            console.error('Error detecting dimensions:', data.error);
                        }
                    })
                    .catch(error => {
                        window.hideLoading();
                        console.error('Error:', error);
                        document.getElementById('auto_dimensions').innerHTML = `
                            <div class="alert alert-warning mb-3">
                                <div class="mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Couldn't detect dimensions:</strong> Please enter them manually.
                                </div>
                            </div>
                        `;
                    });
                }
            });
            
            // Toggle custom paper size options
            document.getElementById('use_custom_paper').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('standard_paper_options').classList.add('d-none');
                    document.getElementById('custom_paper_options').classList.remove('d-none');
                    // Update preview with custom size
                    updatePaperVisualization();
                } else {
                    document.getElementById('standard_paper_options').classList.remove('d-none');
                    document.getElementById('custom_paper_options').classList.add('d-none');
                    // Update preview with standard size
                    updatePaperVisualization();
                }
            });
            
            // Update paper visualization when settings change
            function updatePaperVisualization() {
                const useCustomPaper = document.getElementById('use_custom_paper').checked;
                const paperVisual = document.querySelector('.paper-visual');
                
                let width, height;
                
                if (useCustomPaper) {
                    width = parseFloat(document.getElementById('custom_paper_width').value);
                    height = parseFloat(document.getElementById('custom_paper_height').value);
                } else {
                    const paperSelect = document.getElementById('paper_size');
                    const selectedOption = paperSelect.options[paperSelect.selectedIndex];
                    width = parseFloat(selectedOption.getAttribute('data-width'));
                    height = parseFloat(selectedOption.getAttribute('data-height'));
                }
                
                const orientationSelect = document.getElementById('paper_orientation');
                
                // Swap dimensions if landscape
                if (orientationSelect.value === 'landscape' && width < height) {
                    [width, height] = [height, width];
                } else if (orientationSelect.value === 'portrait' && width > height) {
                    [width, height] = [height, width];
                }
                
                // Calculate aspect ratio
                const aspectRatio = height / width;
                
                // Set fixed width and calculate height based on aspect ratio
                const fixedWidth = 120;
                const calculatedHeight = fixedWidth * aspectRatio;
                
                // Update visual dimensions
                paperVisual.style.width = fixedWidth + 'px';
                paperVisual.style.height = calculatedHeight + 'px';
                
                // Update margin visualization
                const marginTop = parseFloat(document.getElementById('margin_top').value) || 10;
                const marginRight = parseFloat(document.getElementById('margin_right').value) || 10;
                const marginBottom = parseFloat(document.getElementById('margin_bottom').value) || 10;
                const marginLeft = parseFloat(document.getElementById('margin_left').value) || 10;
                
                // Calculate percentages
                const topPercent = (marginTop / height) * 100;
                const rightPercent = (marginRight / width) * 100;
                const bottomPercent = (marginBottom / height) * 100;
                const leftPercent = (marginLeft / width) * 100;
                
                // Update printable area
                const printableArea = document.querySelector('.printable-area');
                if (printableArea) {
                    printableArea.style.top = topPercent + '%';
                    printableArea.style.right = rightPercent + '%';
                    printableArea.style.bottom = bottomPercent + '%';
                    printableArea.style.left = leftPercent + '%';
                    printableArea.style.width = (100 - leftPercent - rightPercent) + '%';
                    printableArea.style.height = (100 - topPercent - bottomPercent) + '%';
                }
                
                // Update real-time preview
                updateRealTimePreview();
            }
            
            // Real-time preview function
            function updateRealTimePreview() {
                // Check if we have all necessary values
                const stickerWidth = parseFloat(document.getElementById('sticker_width').value);
                const stickerHeight = parseFloat(document.getElementById('sticker_height').value);
                
                if (!stickerWidth || !stickerHeight) {
                    return; // Missing required values
                }
                
                const useCustomPaper = document.getElementById('use_custom_paper').checked;
                let paperWidth, paperHeight;
                
                if (useCustomPaper) {
                    paperWidth = parseFloat(document.getElementById('custom_paper_width').value);
                    paperHeight = parseFloat(document.getElementById('custom_paper_height').value);
                } else {
                    const paperSelect = document.getElementById('paper_size');
                    const selectedOption = paperSelect.options[paperSelect.selectedIndex];
                    paperWidth = parseFloat(selectedOption.getAttribute('data-width'));
                    paperHeight = parseFloat(selectedOption.getAttribute('data-height'));
                }
                
                const orientationSelect = document.getElementById('paper_orientation');
                
                // Swap dimensions if landscape
                if (orientationSelect.value === 'landscape' && paperWidth < paperHeight) {
                    [paperWidth, paperHeight] = [paperHeight, paperWidth];
                } else if (orientationSelect.value === 'portrait' && paperWidth > paperHeight) {
                    [paperWidth, paperHeight] = [paperHeight, paperWidth];
                }
                
                // Get margins and spacing
                const marginTop = parseFloat(document.getElementById('margin_top').value) || 10;
                const marginRight = parseFloat(document.getElementById('margin_right').value) || 10;
                const marginBottom = parseFloat(document.getElementById('margin_bottom').value) || 10;
                const marginLeft = parseFloat(document.getElementById('margin_left').value) || 10;
                const horizontalSpacing = parseFloat(document.getElementById('horizontal_spacing').value) || 2;
                const verticalSpacing = parseFloat(document.getElementById('vertical_spacing').value) || 2;
                
                // Calculate printable area
                const printableWidth = paperWidth - marginLeft - marginRight;
                const printableHeight = paperHeight - marginTop - marginBottom;
                
                // Calculate how many stickers fit
                const stickersPerRow = Math.floor((printableWidth + horizontalSpacing) / (stickerWidth + horizontalSpacing));
                const rowsPerPage = Math.floor((printableHeight + verticalSpacing) / (stickerHeight + verticalSpacing));
                
                // Calculate total stickers per page
                const totalStickers = stickersPerRow * rowsPerPage;
                
                // Update sticker count display
                document.getElementById('sticker-count').textContent = totalStickers;
                
                // Show preview
                document.getElementById('realtime-preview').style.display = 'block';
                
                // Clear previous dots
                const previewCanvas = document.getElementById('preview-canvas');
                previewCanvas.innerHTML = '';
                
                // Set canvas dimensions based on paper size
                const aspectRatio = paperHeight / paperWidth;
                const canvasWidth = 150;
                const canvasHeight = canvasWidth * aspectRatio;
                previewCanvas.style.width = canvasWidth + 'px';
                previewCanvas.style.height = canvasHeight + 'px';
                
                // Scale factor for preview
                const scaleX = canvasWidth / paperWidth;
                const scaleY = canvasHeight / paperHeight;
                
                // Create dots for each sticker
                for (let row = 0; row < rowsPerPage; row++) {
                    for (let col = 0; col < stickersPerRow; col++) {
                        const x = marginLeft + col * (stickerWidth + horizontalSpacing) + (stickerWidth / 2);
                        const y = marginTop + row * (stickerHeight + verticalSpacing) + (stickerHeight / 2);
                        
                        // Scale coordinates to preview size
                        const previewX = x * scaleX;
                        const previewY = y * scaleY;
                        
                        // Create a dot
                        const dot = document.createElement('div');
                        dot.className = 'sticker-dot';
                        dot.style.left = previewX + 'px';
                        dot.style.top = previewY + 'px';
                        
                        previewCanvas.appendChild(dot);
                    }
                }
            }
            
            // Add event listeners to update visualization when inputs change
            document.getElementById('paper_orientation').addEventListener('change', updatePaperVisualization);
            document.getElementById('paper_size').addEventListener('change', updatePaperVisualization);
            document.getElementById('custom_paper_width').addEventListener('input', updatePaperVisualization);
            document.getElementById('custom_paper_height').addEventListener('input', updatePaperVisualization);
            
            ['margin_top', 'margin_right', 'margin_bottom', 'margin_left', 
             'horizontal_spacing', 'vertical_spacing', 'sticker_width', 'sticker_height'].forEach(id => {
                document.getElementById(id).addEventListener('input', updatePaperVisualization);
            });
            
            // Initialize paper visualization
            updatePaperVisualization();
            
            // Help modal
            document.getElementById('help-btn').addEventListener('click', function() {
                const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
                helpModal.show();
            });
            
            // Form submission
            document.getElementById('layout-form').addEventListener('submit', function() {
                // Show loading indicator
                window.showLoading('Calculating optimal layout...');
            });
        });
    </script>
</body>
</html>